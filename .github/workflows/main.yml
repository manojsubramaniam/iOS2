name: Deploy

on:
  # Trigger the workflow on push
  # but only for the master branch
  push:
    branches:
      - main
jobs:
  Build:
    runs-on: macOS-latest
    steps:
    - name: Dump file hierarchy
      run: ls -R  
    - uses: actions/checkout@v1
    
    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode.app
      
    - name: Xcode version
      run: /usr/bin/xcodebuild -version
    
    - name: Install the Apple certificate and provisioning profile
      env:
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
        # Copy the certificate and provisioning profile to the correct locations
        cp Certificates.p12 $RUNNER_TEMP/build_certificate.p12
        cp DemoTest.mobileprovision $RUNNER_TEMP/build_pp.mobileprovision

        # Import the certificate to the user keychain
        security import $RUNNER_TEMP/build_certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k ~/Library/Keychains/login.keychain-db
        security list-keychain -d user -s ~/Library/Keychains/login.keychain-db

        # Apply the provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $RUNNER_TEMP/build_pp.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles

        gem install xcodeproj
        ruby - <<EOF
        require 'xcodeproj'

        # Define the path to your Xcode project
        project_path = 'SignIn/SignIn.xcodeproj'

        # Define the target name
        target_name = 'SignIn'

        # Define the provisioning profile specifier
        provisioning_profile_specifier = "DemoTest"

        # Open the Xcode project
        project = Xcodeproj::Project.open(project_path)

        # Find the target
        target = project.targets.find { |t| t.name == target_name }

        # Update the provisioning profile settings
        target.build_configuration_list.build_configurations.each do |configuration|
          configuration.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = provisioning_profile_specifier
        end

        # Save the changes to the Xcode project file
        project.save
        EOF


    - name: Build archive
      run: |
        xcodebuild -sdk iphoneos -project SignIn/SignIn.xcodeproj \
          -configuration Release -scheme SignIn \
          -derivedDataPath DerivedData \
          -archivePath DerivedData/Archive/SignIn archive
