name: iOS starter workflow
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

jobs:
  build:
    name: Build and Test default scheme using any available iPhone simulator
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: check Xcode version
        run: /usr/bin/xcodebuild -version

      - name: Install the Apple certificate and provisioning profile
        env:
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          # Copy the certificate and provisioning profile to the correct locations
          cp Certificates.p12 $RUNNER_TEMP/build_certificate.p12
          cp DemoTest.mobileprovision $RUNNER_TEMP/build_pp.mobileprovision

          # Convert Mobile Provision to Base64
          MOBILE_PROVISION_CONTENT=$(cat $RUNNER_TEMP/build_pp.mobileprovision | base64)
          echo "::set-output name=mobile_provision_content::${MOBILE_PROVISION_CONTENT}"

          # Import the certificate to the user keychain
          security import $RUNNER_TEMP/build_certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k ~/Library/Keychains/login.keychain-db
          security list-keychain -d user -s ~/Library/Keychains/login.keychain-db

          # Apply the provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $RUNNER_TEMP/build_pp.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles

      # ... (Other steps remain unchanged)

      - name: Copy ExportOptions.plist
        run: cp ExportOptions.plist SignIn/ExportOptions.plist

      
      - name: Convert Mobile Provision to Base64
        id: convert-to-base64
        run: |
          # Read the content of the mobile provision file, encode it to base64, and store it in an output variable
          MOBILE_PROVISION_CONTENT=$(cat DemoTest.mobileprovision | base64 | tr -d '\n')
          echo "::set-output name=base64_output::${MOBILE_PROVISION_CONTENT}"

      - name: Build and Export iOS App
        uses: yukiarrr/ios-build-action@v1.11.0
        with:
          project-path: SignIn/SignIn.xcodeproj
          p12-base64: ${{ secrets.P12_PASSWORD }}
          code-signing-identity: ${{ secrets.CODE_SIGNING_IDENTITY }}
          team-id: ${{ secrets.TEAM_ID }}
          workspace-path: SignIn/SignIn.xcworkspace
          export-method: development
          configuration: Release
          output-path: output.ipa
          custom-keychain-name: ios-build.keychain
          export-options: ExportOptions.plist
        env:
          MOBILEPROVISION_BASE64: ${{ steps.convert-to-base64.outputs.base64_output }}

