name: iOS Starter Workflow

on:
  push:
    branches:
      - main  # Change this to the branch you want to trigger the build on

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up CocoaPods
        run: |
          gem install cocoapods
          pod setup

      - name: Install CocoaPods dependencies
        run: |
          cd SignIn  # Navigate to the project directory
          pod install

      - name: Install the Apple certificate and provisioning profile
        env:
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          echo "Copying Certificates.p12 and DemoTest.mobileprovision to SignIn directory"
          cp Certificates.p12 SignIn/
          cp DemoTest.mobileprovision SignIn/

          echo "Creating build.keychain"
          security create-keychain -p "" build.keychain

          echo "Importing Certificates.p12 to build.keychain"
          security import Certificates.p12 -k ~/Library/Keychains/build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign

          echo "Importing DemoTest.mobileprovision to build.keychain"
          security import DemoTest.mobileprovision -k ~/Library/Keychains/build.keychain -T /usr/bin/codesign

          echo "Listing user keychains"
          security list-keychains -d user -s build.keychain

          echo "Setting default keychain to build.keychain"
          security default-keychain -s build.keychain

          echo "Unlocking build.keychain"
          security unlock-keychain -p "" build.keychain

          echo "Setting keychain settings"
          security set-keychain-settings -t 3600 -u build.keychain
          
      - name: Update provisioning profile specifier in Xcode project
        run: |
          gem install xcodeproj
          ruby - <<EOF
          require 'xcodeproj'

          # Define the path to your Xcode project
          project_path = 'SignIn/SignIn.xcodeproj'

          # Define the target name
          target_name = 'SignIn'

          # Define the provisioning profile specifier
          provisioning_profile_specifier = "DemoTest"

          # Open the Xcode project
          project = Xcodeproj::Project.open(project_path)

          # Find the target
          target = project.targets.find { |t| t.name == target_name }

          # Update the provisioning profile settings
          target.build_configuration_list.build_configurations.each do |configuration|
            configuration.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = provisioning_profile_specifier
          end

          # Save the changes to the Xcode project file
          project.save
          EOF

      - name: Build and Archive
        run: |
          cd SignIn
          xcodebuild clean archive -project SignIn.xcodeproj -scheme SignIn -archivePath SignIn.xcarchive
          xcodebuild -exportArchive -archivePath SignIn.xcarchive -exportPath build -exportOptionsPlist ExportOptions.plist
